{% extends "base.html" %}
{% block title %}Billing — EZ Solutions{% endblock %}

{% block content %}
<section class="bg-gray-50 dark:bg-gray-900 py-8 px-4">
    <div class="max-w-3xl mx-auto">
        <!-- Header -->
        <div class="flex items-center gap-3 mb-6">
            <a href="{% url 'users:dashboard' %}" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
            </a>
            <div>
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Billing &amp; Subscription</h2>
                <p class="text-gray-500 dark:text-gray-400 text-sm">Manage your plan and payment details</p>
            </div>
        </div>

        <!-- Current Plan -->
        <div class="bg-white rounded-lg shadow dark:bg-gray-800 p-6 mb-6">
            <h5 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-primary-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"/></svg>
                Current Plan
            </h5>
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                    <span class="bg-primary-100 text-primary-800 text-sm font-semibold px-3 py-1 rounded dark:bg-primary-900 dark:text-primary-300">
                        {{ request.user.get_subscription_tier_display }}
                    </span>
                    {% if subscription %}
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">
                        Status:
                        {% if subscription.is_active %}
                        <span class="text-green-600 font-semibold">Active</span>
                        {% elif subscription.is_past_due %}
                        <span class="text-yellow-600 font-semibold">Past Due — please update your payment method</span>
                        {% else %}
                        <span class="text-red-600 font-semibold">{{ subscription.get_status_display }}</span>
                        {% endif %}
                    </p>
                    {% if subscription.current_period_end %}
                    <p class="text-sm text-gray-500 dark:text-gray-400">
                        {% if subscription.cancel_at_period_end %}
                        Cancels on {{ subscription.current_period_end|date:"N j, Y" }}
                        {% else %}
                        Renews on {{ subscription.current_period_end|date:"N j, Y" }}
                        ({{ subscription.days_until_renewal }} day{{ subscription.days_until_renewal|pluralize }} away)
                        {% endif %}
                    </p>
                    {% endif %}
                    {% else %}
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">You are on the free tier. Upgrade to access VPS hosting, priority support, and more.</p>
                    {% endif %}
                </div>
                <div class="flex flex-wrap gap-2">
                    {% if subscription %}
                    <form method="post" action="{% url 'orders:billing_portal' %}" class="inline">
                        {% csrf_token %}
                        <button type="submit" class="text-gray-900 bg-white border border-gray-300 hover:bg-gray-100 focus:ring-4 focus:ring-gray-200 font-medium rounded-lg text-sm px-4 py-2 dark:bg-gray-800 dark:text-white dark:border-gray-600 dark:hover:bg-gray-700" title="Opens the Stripe billing portal in a new tab">
                            Manage Plan &amp; Payment →
                        </button>
                    </form>
                    {% endif %}
                    <a href="{% url 'services:pricing' %}" class="text-white bg-primary-600 hover:bg-primary-700 focus:ring-4 focus:ring-primary-300 font-medium rounded-lg text-sm px-4 py-2 dark:bg-primary-600 dark:hover:bg-primary-700 dark:focus:ring-primary-800">
                        {% if request.user.is_paid %}Change Plan{% else %}Upgrade now — unlock VPS hosting &amp; priority support{% endif %}
                    </a>
                </div>
            </div>
        </div>

        <!-- Payment Method -->
        {% if subscription %}
        <div class="bg-white rounded-lg shadow dark:bg-gray-800 p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h5 class="text-lg font-bold text-gray-900 dark:text-white mb-1">Payment Method</h5>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Managed securely via Stripe</p>
                </div>
                <form method="post" action="{% url 'orders:billing_portal' %}" class="inline">
                    {% csrf_token %}
                    <button type="submit" class="text-primary-600 hover:text-primary-700 dark:text-primary-400 text-sm font-medium">
                        Update →
                    </button>
                </form>
            </div>
        </div>
        {% endif %}

        <!-- Order History Link -->
        <div class="bg-white rounded-lg shadow dark:bg-gray-800 p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h5 class="text-lg font-bold text-gray-900 dark:text-white mb-1">Order History</h5>
                    <p class="text-sm text-gray-500 dark:text-gray-400">View all your past orders and payments</p>
                </div>
                <a href="{% url 'orders:order_history' %}" class="text-primary-600 hover:text-primary-700 dark:text-primary-400 text-sm font-medium">
                    View History →
                </a>
            </div>
        </div>

        <!-- No subscription CTA -->
        {% if not subscription and not request.user.is_paid %}
        <div class="bg-primary-50 dark:bg-gray-800 rounded-lg p-8 text-center border border-primary-100 dark:border-gray-700">
            <svg class="w-12 h-12 mx-auto text-primary-600 dark:text-primary-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.59 14.37a6 6 0 01-5.84 7.38v-4.8m5.84-2.58a14.98 14.98 0 006.16-12.12A14.98 14.98 0 009.631 8.41m5.96 5.96a14.926 14.926 0 01-5.841 2.58m-.119-8.54a6 6 0 00-7.381 5.84h4.8m2.581-5.84a14.927 14.927 0 00-2.58 5.84m2.699 2.7c-.103.021-.207.041-.311.06a15.09 15.09 0 01-2.448-2.448 14.9 14.9 0 01.06-.312m-2.24 2.39a4.493 4.493 0 00-1.757 4.306 4.493 4.493 0 004.306-1.758M16.5 9a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"/>
            </svg>
            <h5 class="text-xl font-bold text-gray-900 dark:text-white mb-2">Ready to unlock more?</h5>
            <p class="text-gray-500 dark:text-gray-400 mb-4">Choose a plan and get started in minutes — no credit card needed for the trial.</p>
            <a href="{% url 'services:pricing' %}" class="text-white bg-primary-600 hover:bg-primary-700 focus:ring-4 focus:ring-primary-300 font-medium rounded-lg px-5 py-2.5 dark:bg-primary-600 dark:hover:bg-primary-700 dark:focus:ring-primary-800">
                View Plans
            </a>
        </div>
        {% endif %}
    </div>
</section>
{% endblock %}
